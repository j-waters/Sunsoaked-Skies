import{SceneBase as w}from"./SceneBase.js";import p from"../sprites/map/MapLocationSprite.js";import x from"../sprites/map/MapShipSprite.js";var y=Phaser.Curves.QuadraticBezier,F=Phaser.Geom.Point,G=Phaser.Math.Vector2,z=Phaser.Curves.CubicBezier,H=Phaser.GameObjects.Graphics;export default class I extends w{constructor(){super(...arguments);this.mapSize=512*4}preload(){p.setupPipelines(this)}create(c){this.world=c.world,this.map=this.add.image(0,0,this.world.generateTexture(this,512)),this.map.setOrigin(0,0),this.map.setDisplaySize(this.mapSize,this.mapSize),this.map.texture.setFilter(Phaser.Textures.FilterMode.NEAREST),this.input.setDefaultCursor("url(assets/images/map/blank.svg), pointer"),this.world.locations.forEach(a=>{let b=new p(this,a);this.add.existing(b)}),this.playerShip=new x(this,this.dataStore.playerShip);let d=this.mapSize/this.world.size;this.playerShip.setDisplaySize(5*d,8*d),this.add.existing(this.playerShip),this.cameras.main.startFollow(this.playerShip),this.cameras.main.setZoom(2*(this.gameHeight/this.mapSize)),this.input.on(Phaser.Input.Events.POINTER_WHEEL,(a,b,f,e,r)=>{this.cameras.main.zoom+=-e*(this.gameHeight/this.mapSize)*.01,this.cameras.main.zoom>10*(this.gameHeight/this.mapSize)?this.cameras.main.zoom=10*(this.gameHeight/this.mapSize):this.cameras.main.zoom<1&&(this.cameras.main.zoom=1)}),this.cursor=this.add.image(0,0,this.dataStore.playerShip.generateTopDownTexture(this)),this.cursor.setDisplaySize(5*d,8*d),this.cursor.setAlpha(.5),this.curve=this.add.graphics(),this.input.on(Phaser.Input.Events.POINTER_DOWN,a=>this.pointerDown(a)),this.input.on(Phaser.Input.Events.POINTER_MOVE,(a,b)=>this.pointerMove(a,b)),this.events.on(Phaser.Scenes.Events.WAKE,()=>this.wake()),this.wake()}wake(){this.input.setDefaultCursor("url(assets/images/map/blank.svg), pointer")}pointerMove(c,d){let a=c.positionToCamera(this.cameras.main);this.cursor.setPosition(a.x,a.y);let b=q(this.playerShip.getCenter(),this.playerShip.ship.velocity.clone().setLength(this.playerShip.ship.turningModifier),a);this.curve.clear();let f=1;this.playerShip.ship.movementProgress>.8&&(f*=(1-this.playerShip.ship.movementProgress)/.2),this.curve.lineStyle(1,0,f),this.playerShip.ship.targetCurve?.draw(this.curve),this.curve.lineStyle(1,0,.5),b.draw(this.curve),this.cursor.setRotation(b.getTangentAt(1).angle()-Math.PI/2)}pointerDown(c){let d=c.positionToCamera(this.cameras.main),a=q(this.playerShip.getCenter(),this.playerShip.ship.velocity.clone().setLength(this.playerShip.ship.turningModifier),d);this.playerShip.moveTo(a)}update(c,d){super.update(c,d),this.playerShip.update(),this.pointerMove(this.input.activePointer,[])}}function q(c,d,a,b){let f=c.clone().subtract(a);f.x=Math.abs(f.x),f.y=Math.abs(f.y);let e=Phaser.Math.Angle.Normalize(Phaser.Math.Angle.BetweenPoints(c,a)-d.angle()),r=Phaser.Math.Angle.Normalize(Math.PI/2-e),A=Phaser.Math.Distance.BetweenPoints(c,a)*Math.sin(r),j=c.clone().add(d.clone().setLength(A/2)),h=new y(c,j,a),s=h.getTangentAt(1),k=s.angle(),t=d.angle()-Math.PI*1.5,g=Phaser.Math.Angle.Normalize(k-t);e<Math.PI*1.5&&e>Math.PI?(g-=Math.PI*1.5-e,g<Math.PI/2&&(g=Math.PI/2)):e>Math.PI/2&&e<Math.PI&&(g+=e-Math.PI/2,g>Math.PI/2&&(g=Math.PI/2)),k=g+t;let i=d.clone();i.length()>a.clone().distance(c)/2&&i.setLength(a.clone().distance(c)/2);let B=i.clone().setAngle(k),l=c,m=c.clone().add(i),n=a.clone().subtract(B),o=a,u=new z(l,m,n,o);if(b){b.clear(),b.lineStyle(2,16711935,1),b.lineBetween(c.x,c.y,j.x,j.y),h.draw(b);let v=h.getEndPoint().add(s.setLength(40));b.lineStyle(1,16711680,1),b.lineBetween(h.getEndPoint().x,h.getEndPoint().y,v.x,v.y),b.lineStyle(1,65280,1),u.draw(b),b.lineStyle(1,255,1),b.lineBetween(l.x,l.y,m.x,m.y),b.lineBetween(n.x,n.y,o.x,o.y)}return u}
