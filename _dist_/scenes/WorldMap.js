import{SceneBase as w}from"./SceneBase.js";import p from"../sprites/map/MapLocationSprite.js";import x from"../sprites/map/MapShipSprite.js";var y=Phaser.Curves.QuadraticBezier,F=Phaser.Geom.Point,G=Phaser.Math.Vector2,z=Phaser.Curves.CubicBezier,H=Phaser.GameObjects.Graphics;export default class I extends w{constructor(){super(...arguments);this.mapSize=512*4}preload(){p.setupPipelines(this)}create(b){this.world=b.world,this.map=this.add.image(0,0,this.world.generateTexture(this,512)),this.map.setOrigin(0,0),this.map.setDisplaySize(this.mapSize,this.mapSize),this.map.texture.setFilter(Phaser.Textures.FilterMode.NEAREST),this.world.locations.forEach(c=>{let a=new p(this,c);this.add.existing(a)}),this.playerShip=new x(this,this.dataStore.playerShip);let d=this.mapSize/this.world.size;this.playerShip.setDisplaySize(10*d,13*d),this.add.existing(this.playerShip),this.cameras.main.startFollow(this.playerShip),this.cameras.main.setZoom(5*(this.gameHeight/this.mapSize)),this.input.setDefaultCursor("url(assets/images/map/blank.svg), pointer"),this.input.on(Phaser.Input.Events.POINTER_WHEEL,(c,a,g,e,r)=>{this.cameras.main.zoom+=-e*(this.gameHeight/this.mapSize)*.01,this.cameras.main.zoom>10*(this.gameHeight/this.mapSize)?this.cameras.main.zoom=10*(this.gameHeight/this.mapSize):this.cameras.main.zoom<1&&(this.cameras.main.zoom=1),console.log(this.cameras.main.zoom)}),this.cursor=this.add.image(0,0,this.dataStore.playerShip.generateTopDownTexture(this)),this.cursor.setDisplaySize(10*d,13*d),this.cursor.setAlpha(.5),this.curve=this.add.graphics(),this.input.on(Phaser.Input.Events.POINTER_DOWN,c=>this.pointerDown(c)),this.input.on(Phaser.Input.Events.POINTER_MOVE,(c,a)=>this.pointerMove(c,a))}pointerMove(b,d){let c=b.positionToCamera(this.cameras.main);this.cursor.setPosition(c.x,c.y);let a=q(this.playerShip.getCenter(),this.playerShip.ship.velocity.clone().setLength(this.playerShip.ship.turningModifier),c);this.curve.clear(),this.curve.lineStyle(1,0,1),this.playerShip.targetCurve?.draw(this.curve),this.curve.lineStyle(1,0,.5),a.draw(this.curve),this.cursor.setRotation(a.getTangentAt(1).angle()-Math.PI/2)}pointerDown(b){let d=b.positionToCamera(this.cameras.main);this.playerShip.targetCurve=q(this.playerShip.getCenter(),this.playerShip.ship.velocity.clone().setLength(this.playerShip.ship.turningModifier),d),this.playerShip.progress=0}update(b,d){super.update(b,d),this.playerShip.update(),this.pointerMove(this.input.activePointer,[])}}function q(b,d,c,a){let g=b.clone().subtract(c);g.x=Math.abs(g.x),g.y=Math.abs(g.y);let e=Phaser.Math.Angle.Normalize(Phaser.Math.Angle.BetweenPoints(b,c)-d.angle()),r=Phaser.Math.Angle.Normalize(Math.PI/2-e),A=Phaser.Math.Distance.BetweenPoints(b,c)*Math.sin(r),j=b.clone().add(d.clone().setLength(A/2)),h=new y(b,j,c),s=h.getTangentAt(1),k=s.angle(),t=d.angle()-Math.PI*1.5,f=Phaser.Math.Angle.Normalize(k-t);e<Math.PI*1.5&&e>Math.PI?(f-=Math.PI*1.5-e,f<Math.PI/2&&(f=Math.PI/2)):e>Math.PI/2&&e<Math.PI&&(f+=e-Math.PI/2,f>Math.PI/2&&(f=Math.PI/2)),k=f+t;let i=d.clone();i.length()>c.clone().distance(b)/2&&i.setLength(c.clone().distance(b)/2);let B=i.clone().setAngle(k),l=b,m=b.clone().add(i),n=c.clone().subtract(B),o=c,u=new z(l,m,n,o);if(a){a.clear(),a.lineStyle(2,16711935,1),a.lineBetween(b.x,b.y,j.x,j.y),h.draw(a);let v=h.getEndPoint().add(s.setLength(40));a.lineStyle(1,16711680,1),a.lineBetween(h.getEndPoint().x,h.getEndPoint().y,v.x,v.y),a.lineStyle(1,65280,1),u.draw(a),a.lineStyle(1,255,1),a.lineBetween(l.x,l.y,m.x,m.y),a.lineBetween(n.x,n.y,o.x,o.y)}return u}
